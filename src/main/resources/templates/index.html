<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ğŸ’¾ SQL æ‰§è¡Œå™¨</title>

    <!-- å¼•å…¥æœ¬åœ°èµ„æº -->
    <script src="/js/codemirror.min.js"></script>
    <link rel="stylesheet" href="/css/codemirror.min.css">
    <script src="/js/sql.min.js"></script>
    <script src="/js/tailwind.js"></script>
    <link href="/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .result-table {
                @apply min-w-full divide-y divide-gray-200;
            }
            .result-table th {
                @apply px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
                position: relative;
                user-select: none;
            }
            .result-table td {
                @apply px-4 py-2 whitespace-nowrap text-sm text-gray-700;
                max-width: 300px;
                overflow-x: auto;
            }
            .result-table tr:nth-child(even) {
                @apply bg-gray-50;
            }
            .resizer {
                position: absolute;
                top: 0;
                right: 0;
                width: 5px;
                height: 100%;
                background-color: transparent;
                cursor: col-resize;
                user-select: none;
            }
            .resizer:hover, .resizing {
                background-color: #ccc;
            }
        }
    </style>
    <style>
        .scroll-container {
            width: 100%;
            max-width: 1600px;
            height: 800px;
            overflow: auto;
            border: 1px solid #ccc;
        }
        .sql-history-item {
            position: relative;
        }
        .sql-history-item .delete-history {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .sql-history-item:hover .delete-history {
            opacity: 1;
        }
        #sql-editor {
            min-height: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .CodeMirror {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 14px;
            height: auto !important;
            border-radius: 4px;
        }
        .CodeMirror-cursor {
            border-left: 2px solid #2563eb !important;
        }
        /* å…³é”®ä¿®å¤ï¼šç¡®ä¿æŒ‰é’®å®¹å™¨ä¸è¢«éšè— */
        .button-group {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            min-width: 140px !important; /* ç¡®ä¿æŒ‰é’®ç»„æœ‰è¶³å¤Ÿå®½åº¦ */
        }
    </style>

</head>
<body class="bg-gray-50 font-sans">
<div class="min-h-screen flex flex-col">
    <!-- å¯¼èˆªæ  -->
    <header class="bg-white shadow-sm">
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                        <span class="text-xl font-bold text-blue-600 flex items-center">
                            <i class="fa fa-database mr-2"></i>
                            SQL æ‰§è¡Œå™¨
                        </span>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="flex-grow">
        <div class="w-full mx-auto py-6 sm:px-6 lg:px-8">
            <!-- æ¶ˆæ¯æç¤º -->
            <div class="mb-6">
                <div id="message-container"></div>
                <div th:if="${message}" class="bg-green-50 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">æˆåŠŸ!</strong>
                    <span class="block sm:inline" th:text="${message}"></span>
                </div>
                <div th:if="${error}" class="bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">é”™è¯¯!</strong>
                    <span class="block sm:inline" th:text="${error}"></span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="flex flex-col md:flex-row">
                    <!-- å·¦ä¾§é¢æ¿ - æ•°æ®åº“é…ç½® -->
                    <div class="w-full md:w-64 bg-gray-50 border-r border-gray-200 p-4">
                        <!-- å·¦ä¾§å†…å®¹ä¿æŒä¸å˜ -->
                        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">æ•°æ®åº“é…ç½®</h3>

                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-medium text-gray-500">å·²é…ç½®çš„æ•°æ®åº“</span>
                                <button id="add-database-btn" class="text-blue-600 hover:text-blue-800 text-xs flex items-center">
                                    <i class="fa fa-plus-circle mr-1"></i> æ·»åŠ 
                                </button>
                            </div>

                            <div class="space-y-1">
                                <a href="#" th:href="@{/switch-database/{name}(name=${configKey})}"
                                   th:each="configKey : ${databaseConfigs.keySet()}"
                                   class="block px-3 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100"
                                   th:text="${configKey  +' (' + (databaseConfigs.get(configKey)?.databaseName ?: 'æœªçŸ¥æ•°æ®åº“') + ')'}">
                                    default (dsb)
                                </a>
                            </div>
                        </div>

                        <div id="add-database-form" class="hidden mb-6 p-3 bg-white rounded-md border border-gray-200">
                            <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-3">æ·»åŠ æ•°æ®åº“è¿æ¥</h4>

                            <form method="post" id="add-database-connection" onsubmit="return false;">
                                <div class="mb-2">
                                    <label for="host" class="block text-xs font-medium text-gray-700 mb-1">ä¸»æœº IP</label>
                                    <input type="text" id="host" name="host"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                           placeholder="192.168.1.1">
                                    <p id="host-error" class="text-red-500 text-xs mt-1 hidden">è¯·è¾“å…¥æœ‰æ•ˆçš„ä¸»æœº IP</p>
                                </div>

                                <div class="mb-2">
                                    <label for="port" class="block text-xs font-medium text-gray-700 mb-1">ç«¯å£</label>
                                    <input type="number" id="port" name="port" min="1" max="65535" value="1433"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                           placeholder="1433">
                                    <p id="port-error" class="text-red-500 text-xs mt-1 hidden">è¯·è¾“å…¥æœ‰æ•ˆçš„ç«¯å£å·</p>
                                </div>

                                <div class="mb-2">
                                    <label for="username" class="block text-xs font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                                    <input type="text" id="username" name="username"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                           placeholder="sa">
                                </div>

                                <div class="mb-2">
                                    <label for="password" class="block text-xs font-medium text-gray-700 mb-1">å¯†ç </label>
                                    <input type="password" id="password" name="password"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                           placeholder="123456">
                                </div>

                                <div class="flex justify-end">
                                    <button type="button" id="cancel-add-database" class="px-3 py-1 border border-transparent rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fa fa-times mr-1"></i> å–æ¶ˆ
                                    </button>
                                    <button type="submit" id="test-connection" class="ml-2 px-3 py-1 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fa fa-check-circle mr-1"></i> æµ‹è¯•è¿æ¥
                                    </button>
                                </div>

                                <div id="database-selection" class="mt-4 hidden">
                                    <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">é€‰æ‹©æ•°æ®åº“</h4>
                                    <div class="space-y-1 max-h-40 overflow-y-auto p-1 border border-gray-200 rounded-md">
                                        <div id="databases-list" class="space-y-1">
                                            <!-- æ•°æ®åº“åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                                        </div>
                                    </div>
                                    <div class="flex justify-end mt-3">
                                        <input type="hidden" id="selected-database" name="selected-database">
                                        <button type="button" id="save-database" class="ml-2 px-3 py-1 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                            <i class="fa fa-save mr-1"></i> ä¿å­˜é…ç½®
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="mt-6">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider">SQL å†å²è®°å½•</h3>
                                <button id="clear-all-history" class="text-red-500 hover:text-red-700 text-xs flex items-center">
                                    <i class="fa fa-trash mr-1"></i> æ¸…ç©º
                                </button>
                            </div>
                            <div id="sql-history" class="space-y-1 max-h-[30rem] overflow-y-auto p-1"></div>
                        </div>
                    </div>

                    <!-- å³ä¾§é¢æ¿ - SQL ç¼–è¾‘å™¨å’Œç»“æœ -->
                    <div class="flex-1 p-6 overflow-hidden">
                        <div class="mb-6">
                            <!-- å…³é”®ä¿®å¤ï¼šä¿®æ”¹æŒ‰é’®å®¹å™¨ï¼Œä¸ºå³ä¸Šè§’æ‰§è¡ŒæŒ‰é’®æ·»åŠ ID -->
                            <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
                                <h3 class="text-lg font-medium text-gray-900">SQL ç¼–è¾‘å™¨</h3>
                                <div class="button-group flex space-x-2">
                                    <button id="clear-sql" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fa fa-eraser mr-1"></i> æ¸…ç©º
                                    </button>
                                    <button id="top-execute-btn" name="execute-sql" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fa fa-play mr-1"></i> æ‰§è¡Œ
                                    </button>
                                </div>
                            </div>

                            <form method="post" id="sql-form" onsubmit="executeSql(); return false;">
                                <input type="hidden" id="sql" name="sql">
                                <div class="mb-3">
                                    <div id="sql-editor"></div>
                                </div>

                                <!-- å…³é”®ä¿®å¤ï¼šä¿®æ”¹åº•éƒ¨æŒ‰é’®å¸ƒå±€ -->
                                <div class="flex flex-wrap items-center gap-2">
                                    <select name="database" class="min-w-[180px] border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option th:each="configKey : ${databaseConfigs.keySet()}"
                                                th:value="${configKey}"
                                                th:selected="${configKey == currentDatabase}"
                                                th:text="${configKey + ' (' + (databaseConfigs.get(configKey)?.databaseName ?: 'æœªçŸ¥æ•°æ®åº“') + ')'}">
                                            default (dsb)
                                        </option>
                                    </select>
                                    <button name="execute-sql" type="submit" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fa fa-play mr-1"></i> æ‰§è¡Œ SQL
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div id="result-section">
                            <h3 class="text-lg font-medium text-gray-900 mb-3">æ‰§è¡Œç»“æœ</h3>

                            <div th:if="${result}" class="scroll-container overflow-x-auto bg-white rounded-md border border-gray-200">
                                <table class="result-table">
                                    <thead>
                                    <tr th:if="${result.size() > 0}">
                                        <th th:each="column : ${result.get(0).keySet()}" th:text="${column}">ID</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:if="${result.size() > 0}" th:each="row : ${result}">
                                        <td th:each="value : ${row.values()}" th:text="${value}">1</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="bg-gray-50 border border-gray-200 rounded-md p-6 text-sm text-gray-600 text-center"
                                 th:unless="${result != null || message != null || error != null}">
                                <i class="fa fa-info-circle mr-1 text-blue-500"></i>
                                <span>æ‰§è¡Œ SQL æŸ¥è¯¢åç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 py-6 mt-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500">
                Â© 2025 SQL æ‰§è¡Œå™¨ - ä¸€ä¸ªç®€å•çš„æ•°æ®åº“ç®¡ç†å·¥å…·
            </p>
        </div>
    </footer>
</div>

<script>
    // JavaScript ä»£ç ä¿æŒä¸å˜
    let editor;

    document.addEventListener('DOMContentLoaded', function() {
        initSqlEditor();

        const initialSql = /*[[${sql}]]*/ '';
        if (initialSql) {
            editor.setValue(initialSql);
        }

        displaySqlHistory();
        initTableResizers();
        bindDatabaseEvents();
    });

    function initSqlEditor() {
        editor = CodeMirror(document.getElementById('sql-editor'), {
            value: '',
            mode: 'text/x-sql',
            lineNumbers: true,
            indentUnit: 4,
            smartIndent: true,
            matchBrackets: true,
            autofocus: true,
            lineWrapping: false,
            extraKeys: {
                'Ctrl-Enter': executeSql
            }
        });

        editor.setSize(null, '300px');

        document.getElementById('clear-sql').addEventListener('click', function() {
            editor.setValue('');
        });
    }

    function executeSql() {
        const sql = editor.getValue().trim();
        if (!sql) {
            showToast('è¯·è¾“å…¥ SQL è¯­å¥', 'error');
            return;
        }

        saveSqlToHistory(sql);

        const database = document.querySelector('[name="database"]').value;

        // æ˜¾ç¤ºåŠ è½½æç¤ºï¼ˆä¸è‡ªåŠ¨æ¶ˆå¤±ï¼‰
        const loadingToast = showToast('æ­£åœ¨æ‰§è¡Œ SQL...', 'loading');

        fetch('/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `sql=${encodeURIComponent(sql)}&database=${encodeURIComponent(database)}`
        })
            .then(response => {
                // å…³é—­åŠ è½½æç¤º
                closeToast(loadingToast);

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = html;

                const errorElement = tempContainer.querySelector('.bg-red-50');
                if (errorElement) {
                    const errorMsg = errorElement.textContent.trim();
                    throw new Error(errorMsg);
                }

                const successElement = tempContainer.querySelector('.bg-green-50');
                if (successElement) {
                    const successMsg = successElement.textContent.trim();
                    showToast(successMsg, 'success');
                }

                const resultContainer = document.querySelector('.scroll-container');
                if (resultContainer) {
                    resultContainer.innerHTML = tempContainer.querySelector('.scroll-container')?.innerHTML || '';
                    initTableResizers();
                } else {
                    const resultSection = document.querySelector('#result-section');
                    if (resultSection) {
                        resultSection.innerHTML = tempContainer.querySelector('#result-section')?.innerHTML || resultSection.innerHTML;
                        initTableResizers();
                    }
                }
            })
            .catch(error => {
                // å…³é—­åŠ è½½æç¤º
                closeToast(loadingToast);

                // æ¸…ç©ºç»“æœåŒºåŸŸ
                const resultContainer = document.querySelector('.scroll-container');
                if (resultContainer) {
                    resultContainer.innerHTML = '';
                }

                showToast(error.message, 'error', 30000);
            });
    }

    function showMessage(message, type = 'error') {
        const container = document.getElementById('message-container');
        container.innerHTML = '';

        let bgColor, textColor, borderColor, icon;

        switch(type) {
            case 'success':
                bgColor = 'bg-green-50';
                textColor = 'text-green-700';
                borderColor = 'border-green-400';
                icon = 'fa-check-circle';
                break;
            case 'error':
                bgColor = 'bg-red-50';
                textColor = 'text-red-700';
                borderColor = 'border-red-400';
                icon = 'fa-exclamation-circle';
                break;
            case 'loading':
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-700';
                borderColor = 'border-blue-400';
                icon = 'fa-spinner fa-spin';
                break;
            default:
                bgColor = 'bg-gray-50';
                textColor = 'text-gray-700';
                borderColor = 'border-gray-400';
                icon = 'fa-info-circle';
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `${bgColor} ${borderColor} ${textColor} px-4 py-3 rounded mb-2 border`;
        msgDiv.innerHTML = `
            <strong class="font-bold">
                <i class="fa ${icon} mr-1"></i>
                ${type === 'success' ? 'æˆåŠŸ' : type === 'error' ? 'é”™è¯¯' : 'åŠ è½½ä¸­'}:
            </strong>
            <span>${message}</span>
        `;
        container.appendChild(msgDiv);

        if (type !== 'loading') {
            setTimeout(() => msgDiv.remove(), 5000);
        }
    }

    function saveSqlToHistory(sql) {
        let history = JSON.parse(localStorage.getItem('sqlHistory') || '[]');
        const index = history.findIndex(item => item.sql === sql);
        if (index > -1) {
            history.splice(index, 1);
        }
        history.unshift({
            sql: sql,
            time: new Date().toISOString()
        });
        if (history.length > 20) {
            history = history.slice(0, 20);
        }
        localStorage.setItem('sqlHistory', JSON.stringify(history));
        displaySqlHistory();
    }

    function displaySqlHistory() {
        const history = JSON.parse(localStorage.getItem('sqlHistory') || '[]');
        const container = document.getElementById('sql-history');
        container.innerHTML = '';

        if (history.length === 0) {
            container.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500 italic">æš‚æ— å†å²è®°å½•</div>';
            return;
        }

        history.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'sql-history-item block px-3 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100';
            div.innerHTML = `
                <div class="truncate">${item.sql}</div>
                <div class="text-xs text-gray-500">${formatTime(item.time)}</div>
                <span class="delete-history text-red-500" data-index="${index}">
                    <i class="fa fa-times-circle"></i>
                </span>
            `;
            div.addEventListener('click', function(e) {
                if (!e.target.closest('.delete-history')) {
                    editor.setValue(item.sql);
                }
            });
            container.appendChild(div);
        });

        document.querySelectorAll('.delete-history').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(this.getAttribute('data-index'));
                let history = JSON.parse(localStorage.getItem('sqlHistory') || '[]');
                history.splice(index, 1);
                localStorage.setItem('sqlHistory', JSON.stringify(history));
                displaySqlHistory();
            });
        });
    }

    function formatTime(timeStr) {
        const date = new Date(timeStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function initTableResizers() {
        const table = document.querySelector('.result-table');
        if (!table) return;

        table.style.tableLayout = 'fixed';

        table.querySelectorAll('.resizer').forEach(resizer => resizer.remove());

        table.querySelectorAll('th').forEach((th, index) => {
            if (index === table.querySelectorAll('th').length - 1) return;

            const resizer = document.createElement('div');
            resizer.className = 'resizer';
            th.appendChild(resizer);

            let startX, startWidth, startClientX;
            let resizing = false;

            resizer.addEventListener('mousedown', function(e) {
                startX = e.pageX;
                startWidth = th.offsetWidth;
                startClientX = e.clientX;
                resizing = true;

                resizer.classList.add('resizing');
                document.body.classList.add('resizing-columns');

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);

                e.preventDefault();
            });

            function handleMouseMove(e) {
                if (!resizing) return;

                const widthChange = e.clientX - startClientX;
                const newWidth = startWidth + widthChange;

                if (newWidth > 80) {
                    th.style.width = newWidth + 'px';
                    th.style.minWidth = newWidth + 'px';
                }
            }

            function handleMouseUp() {
                resizing = false;
                resizer.classList.remove('resizing');
                document.body.classList.remove('resizing-columns');

                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        });
    }

    function bindDatabaseEvents() {
        // æ–°å¢ï¼šç»‘å®šå³ä¸Šè§’æ‰§è¡ŒæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.getElementById('top-execute-btn').addEventListener('click', executeSql);

        // åŸæœ‰ä»£ç ä¿æŒä¸å˜
        document.getElementById('add-database-btn').addEventListener('click', function() {
            document.getElementById('add-database-form').classList.remove('hidden');
        });

        document.getElementById('cancel-add-database').addEventListener('click', function() {
            document.getElementById('add-database-form').classList.add('hidden');
        });

        document.getElementById('test-connection').addEventListener('click', function() {
            const host = document.getElementById('host').value.trim();
            const port = document.getElementById('port').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!host) {
                document.getElementById('host-error').classList.remove('hidden');
                return;
            }
            document.getElementById('host-error').classList.add('hidden');

            if (!port || isNaN(port) || port < 1 || port > 65535) {
                document.getElementById('port-error').classList.remove('hidden');
                return;
            }
            document.getElementById('port-error').classList.add('hidden');

            this.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> è¿æ¥ä¸­...';
            this.disabled = true;

            fetch('/test-connection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({host, port, username, password})
            })
                .then(res => res.json())
                .then(data => {
                    this.innerHTML = '<i class="fa fa-check-circle mr-1"></i> æµ‹è¯•è¿æ¥';
                    this.disabled = false;

                    if (data.success) {
                        const list = document.getElementById('databases-list');
                        list.innerHTML = '';
                        data.databases.forEach(db => {
                            const div = document.createElement('div');
                            div.className = 'cursor-pointer px-3 py-2 text-sm text-gray-700 rounded hover:bg-blue-50';
                            div.textContent = db;
                            div.onclick = function() {
                                document.querySelectorAll('#databases-list div').forEach(el => {
                                    el.classList.remove('bg-blue-50', 'text-blue-700');
                                });
                                this.classList.add('bg-blue-50', 'text-blue-700');
                                document.getElementById('selected-database').value = db;
                            };
                            list.appendChild(div);
                        });
                        document.getElementById('database-selection').classList.remove('hidden');
                    } else {
                        showMessage('è¿æ¥å¤±è´¥: ' + data.message);
                    }
                })
                .catch(err => {
                    this.innerHTML = '<i class="fa fa-check-circle mr-1"></i> æµ‹è¯•è¿æ¥';
                    this.disabled = false;
                    showMessage('è¯·æ±‚å¤±è´¥: ' + err.message);
                });
        });

        document.getElementById('save-database').addEventListener('click', function() {
            const host = document.getElementById('host').value.trim();
            const port = document.getElementById('port').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const database = document.getElementById('selected-database').value;

            if (!host || !port || !username || !database) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            this.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> ä¿å­˜ä¸­...';
            this.disabled = true;

            fetch('/save-connection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({host, port, username, password, database})
            })
                .then(res => res.json())
                .then(data => {
                    this.innerHTML = '<i class="fa fa-save mr-1"></i> ä¿å­˜é…ç½®';
                    this.disabled = false;

                    if (data.success) {
                        showMessage('ä¿å­˜æˆåŠŸ', 'success');
                        document.getElementById('add-database-form').classList.add('hidden');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage('ä¿å­˜å¤±è´¥: ' + data.message);
                    }
                })
                .catch(err => {
                    this.innerHTML = '<i class="fa fa-save mr-1"></i> ä¿å­˜é…ç½®';
                    this.disabled = false;
                    showMessage('è¯·æ±‚å¤±è´¥: ' + err.message);
                });
        });

        document.getElementById('clear-all-history').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('sqlHistory');
                displaySqlHistory();
            }
        });
    }

    // åˆ›å»ºè‡ªåŠ¨æ¶ˆå¤±çš„æç¤ºå¼¹æ¡†
    function showToast(message, type = 'info', duration = 10000) {
        // åˆ›å»ºtoastå®¹å™¨
        const toast = document.createElement('div');

        // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
        let bgColor, textColor, icon;
        switch(type) {
            case 'success':
                bgColor = 'bg-green-50';
                textColor = 'text-green-700';
                icon = 'fa-check-circle';
                break;
            case 'error':
                bgColor = 'bg-red-50';
                textColor = 'text-red-700';
                icon = 'fa-exclamation-circle';
                break;
            case 'loading':
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-700';
                icon = 'fa-spinner fa-spin';
                break;
            default:
                bgColor = 'bg-gray-50';
                textColor = 'text-gray-700';
                icon = 'fa-info-circle';
        }

        // è®¾ç½®æ ·å¼å’Œå†…å®¹
        toast.className = `fixed top-4 right-4 px-4 py-3 rounded-md shadow-lg border ${bgColor} ${textColor} transform transition-all duration-300 translate-x-full opacity-0 z-50`;
        toast.innerHTML = `
        <div class="flex items-center">
            <i class="fa ${icon} mr-2"></i>
            <span>${message}</span>
        </div>
    `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(toast);

        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
        }, 10);

        // è‡ªåŠ¨æ¶ˆå¤±ï¼ˆåŠ è½½çŠ¶æ€ä¸è‡ªåŠ¨æ¶ˆå¤±ï¼‰
        if (type !== 'loading') {
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // è¿”å›toastå…ƒç´ ï¼Œæ–¹ä¾¿æ‰‹åŠ¨å…³é—­
        return toast;
    }

    // å…³é—­ç‰¹å®šçš„toast
    function closeToast(toast) {
        if (toast) {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }
    }
</script>
</body>
</html>